<!DOCTYPE html>
{% extends 'base.html' %}
{% block content %}

<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: #f8f9fa; }
  .table-hover tbody tr:hover { background: #eef2f7; }
  .created-task { background-color: #d0e9ff; } /* sky-blue */
</style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Dashboard | Welcome, {{ user.username }}</h2>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">Logout</a>
  </div>

  <form action="{{ url_for('add_task') }}" method="POST" class="row g-2 mb-4">
    <div class="col-auto flex-grow-1">
      <input type="text" name="content" class="form-control" placeholder="Add new task..." required>
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Add Task</button>
    </div>
  </form>

  {% if user.role == 'admin' %}
  <div class="mb-3">
    <select id="user-filter" class="form-select w-auto d-inline-block">
      <option value="">-- Filter by User --</option>
      {% for u in users %}
      <option value="{{ u.username }}">{{ u.username }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-secondary" onclick="applyFilter()">Filter</button>
  </div>
  {% endif %}

  <table class="table table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Task</th>
        <th>Assigned To</th>
        <th>Assigned On</th>
        <th>Deadline</th>
        <th>Priority</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="task-table">
      {% for task in tasks %}
      <tr class="{% if task.created_by == user.username %}created-task{% endif %}" data-user="{{ task.assigned_to }}">
        <td>{{ loop.index }}</td>
        <td>
          <form method="POST" action="{{ url_for('edit_description', task_id=task.id) }}" class="d-flex">
            <input type="text" name="new_content" value="{{ task.content }}" class="form-control" required>
            <button type="submit" class="btn btn-outline-primary btn-sm ms-2">Save</button>
          </form>
        </td>
        <td>{{ task.assigned_to or '—' }}</td>
        <td>{{ task.assign_date.strftime('%Y-%m-%d') if task.assign_date }}</td>
        <td>{{ task.deadline.strftime('%Y-%m-%d') if task.deadline }}</td>
        <td>{{ task.priority or '—' }}</td>
        <td>
          {% if user.role == 'admin' %}
          <form action="{{ url_for('assign_task', task_id=task.id) }}" method="POST" class="d-flex align-items-center">
            <select name="assigned_to" class="form-select form-select-sm me-1" required>
              <option value="">User</option>
              {% for u in users %}
              <option value="{{ u.username }}" {% if task.assigned_to == u.username %}selected{% endif %}>{{ u.username }}</option>
              {% endfor %}
            </select>
            <select name="priority" class="form-select form-select-sm me-1" required>
              {% for i in range(1, 11) %}
              <option value="{{ i }}" {% if task.priority == i %}selected{% endif %}>{{ i }}</option>
              {% endfor %}
            </select>
            <input type="date" name="deadline" class="form-control form-control-sm me-1" value="{{ task.deadline.strftime('%Y-%m-%d') if task.deadline }}">
            <button class="btn btn-success btn-sm me-1">Assign</button>
          </form>
          {% endif %}

          {% if user.role != 'admin' and task.assigned_to == user.username %}
          <form action="{{ url_for('complete_task', task_id=task.id) }}" method="POST" class="d-inline">
            <button class="btn btn-success btn-sm">Complete</button>
          </form>
          {% endif %}

          <a href="{{ url_for('delete_task', task_id=task.id) }}" class="btn btn-outline-danger btn-sm">Delete</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function applyFilter() {
  const sel = document.getElementById('user-filter');
  const user = sel.value;
  document.querySelectorAll('#task-table tr').forEach(tr => {
    tr.style.display = !user || tr.dataset.user === user ? '' : 'none';
  });
}
</script>

</body>
</html>
{% endblock %}
